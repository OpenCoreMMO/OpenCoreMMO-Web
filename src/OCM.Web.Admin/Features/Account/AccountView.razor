@page "/accounts/{AccountId:int}"
@using MediatR
@using OCM.Application.Requests.Queries
@using OCM.Application.Requests.Commands
@using OCM.Application.Response.Player
@using OCM.Application.Response.Account
@using OCM.Application.Response
@inject IMediator Mediator
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Account #@AccountId</PageTitle>

<MudGrid>
    <!-- Characters Table -->
    <MudItem xs="12" md="8">
        <MudPaper>
            <div Class="pa-6">
                <div Class="d-flex justify-space-between align-center mb-4">
                    <div>
                        <MudText Typo="Typo.h6">Characters</MudText>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">List of all characters on the account</MudText>
                    </div>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" Href="@($"/players/new?accountId={AccountId}")">
                        New Player
                    </MudButton>
                </div>
            </div>

            <MudTable T="PlayerResponseViewModel" ServerData="ServerReload" Dense="true" Hover="true" Class="mt-4">
                <HeaderContent>
                    <MudTh></MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Level</MudTh>
                    <MudTh>Group</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh align="right">Action</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudAvatar Size="Size.Medium">@(context.Name.Length >= 2 ? context.Name.Substring(0, 2).ToUpper() : context.Name.ToUpper())</MudAvatar>
                    </MudTd>
                    <MudTd>
                        <div>@context.Name</div>
                        <div class="text-sm text-secondary">@GetVocationName(context.Vocation)</div>
                    </MudTd>
                    <MudTd>@context.Level</MudTd>
                    <MudTd>@context.Group</MudTd>
                    <MudTd>
                        <MudChip T="string" Color="@(context.Online ? Color.Success : Color.Error)" Variant="Variant.Filled" Size="Size.Small">
                            @(context.Online ? "Online" : "Offline")
                        </MudChip>
                    </MudTd>
                    <MudTd align="right">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary" Href="@($"/player/{context.Id}")"/>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudPaper>
    </MudItem>

    <!-- Account Info -->
    <MudItem xs="12" md="4">
        <MudPaper Class="pa-6" Elevation="2">
            <MudText Typo="Typo.h6">Account Info</MudText>

            <MudTextField Label="Email" @bind-Value="Account.Email" ReadOnly="true" Class="mt-4"
                          Variant="Variant.Outlined"/>
            <MudTextField Label="Password" @bind-Value="Account.Password" InputType="InputType.Password"
                          Variant="Variant.Outlined"/>


            <MudTextField Label="Premium Days" @bind-Value="Account.PremiumDays" Class="mt-4"
                          Variant="Variant.Outlined"/>
            <MudTextField Label="Coins" @bind-Value="Account.Coins" Variant="Variant.Outlined"/>

            <MudSelect T="int" Label="Role" @bind-Value="Account.RoleId" Variant="Variant.Outlined" Class="mt-4" Required="true" RequiredError="Role is required">
                @foreach (var role in AvailableRoles)
                {
                    <MudSelectItem Value="@role.Id">@role.Name</MudSelectItem>
                }
            </MudSelect>

            <MudButton Class="mt-6" Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                       OnClick="SaveChanges">
                Save editions
            </MudButton>
            <MudButton Class="mt-2" Variant="Variant.Filled" Color="Color.Error" FullWidth="true"
                       OnClick="BanAccount">
                Ban Account
            </MudButton>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [Parameter] public int AccountId { get; set; }

    private AccountResponseViewModel Account { get; set; } = new AccountResponseViewModel { RoleId = 1 };
    private IEnumerable<RoleResponseViewModel> AvailableRoles { get; set; } = new List<RoleResponseViewModel>();

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
        await LoadAccount();
        StateHasChanged();
    }

    private async Task LoadAccount()
    {
        var request = new GetAccountsRequest
        {
            // For now, we'll load all accounts and find the one with matching ID
            // In a real implementation, you might want a GetAccountById query
            Page = 1,
            Limit = 1000 // Load enough to find the account
        };

        var response = await Mediator.Send(request);
        Account = response.Data.FirstOrDefault(a => a.Id == AccountId);

        // Ensure RoleId has a valid value
        if (Account != null && Account.RoleId == 0)
        {
            Account.RoleId = 1; // Default to first role
        }
    }

    private async Task LoadRoles()
    {
        var request = new GetRolesRequest();
        var response = await Mediator.Send(request);
        AvailableRoles = response.Data;
    }

    private async Task<TableData<PlayerResponseViewModel>> ServerReload(TableState state, CancellationToken token)
    {
        var request = new GetPlayersRequest
        {
            AccountId = AccountId,
            Page = state.Page + 1,
            Limit = state.PageSize
        };

        var response = await Mediator.Send(request, token);
        return new TableData<PlayerResponseViewModel>
        {
            TotalItems = response.TotalRecords,
            Items = response.Data
        };
    }


    private string GetVocationName(byte vocation)
    {
        return vocation switch
        {
            1 => "Sorcerer",
            2 => "Druid",
            3 => "Paladin",
            4 => "Knight",
            5 => "Master Sorcerer",
            6 => "Elder Druid",
            7 => "Royal Paladin",
            8 => "Elite Knight",
            9 => "Tutor",
            10 => "Game Master",
            11 => "GOD",
            _ => "Unknown"
        };
    }

    private async Task SaveChanges()
    {
        var request = new UpdateAccountRequest
        {
            Id = AccountId,
            Email = Account.Email,
            Password = Account.Password,
            PremiumDays = Account.PremiumDays,
            Coins = Account.Coins,
            RoleId = Account.RoleId
        };

        var response = await Mediator.Send(request);

        if (response.IsSuccess)
        {
            Snackbar.Add("Account updated successfully!", Severity.Success);
            // Reload account data to reflect changes
            await LoadAccount();
        }
        else
        {
            Snackbar.Add($"Error updating account: {response.ErrorMessage}", Severity.Error);
        }
    }

    private async Task BanAccount()
    {
        var result = await DialogService.ShowMessageBox(
            "Confirm Ban",
            "Are you sure you want to ban this account?",
            yesText: "Ban",
            cancelText: "Cancel");

        if (result == true)
        {
            var banRequest = new BanAccountRequest();
            banRequest.SetAccountId(AccountId);
            banRequest.Reason = "Banned by admin";
            banRequest.Days = 7;

            var response = await Mediator.Send(banRequest);

            if (response.IsSuccess)
            {
                Snackbar.Add("Account banned successfully!", Severity.Success);
                await LoadAccount();
            }
            else
            {
                Snackbar.Add($"Error banning account: {response.ErrorMessage}", Severity.Error);
            }
        }
    }
}
